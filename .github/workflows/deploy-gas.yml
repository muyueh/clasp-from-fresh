name: Deploy Taipei 500 Form

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_PATH: taipei-500-form
      SCRIPT_ID_SECRET: TAIPEI_500_FORM_SCRIPT_ID

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install clasp (3.x)
        run: npm install -g @google/clasp@^3.1.0
      - name: Check deploy secrets
        id: deploy-secrets
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
          SCRIPT_ID: ${{ secrets[env.SCRIPT_ID_SECRET] }}
        run: |
          missing=()

          if [[ -z "$CLASPRC_JSON" ]]; then
            missing+=("CLASPRC_JSON")
          fi

          if [[ -z "$SCRIPT_ID" ]]; then
            missing+=("${{ env.SCRIPT_ID_SECRET }}")
          fi

          if [[ ${#missing[@]} -eq 0 ]]; then
            echo "Deploy secrets detected"
            {
              echo "available=true"
              echo "missing="
            } >>"$GITHUB_OUTPUT"
            exit 0
          fi

          printf '::warning::Skipping deploy because the following secrets are unavailable: %s\n' "${missing[*]}"
          {
            echo "available=false"
            echo "missing=${missing[*]}"
          } >>"$GITHUB_OUTPUT"

      - name: Short-circuit when secrets are missing
        if: steps.deploy-secrets.outputs.available != 'true'
        run: |
          missing="${{ steps.deploy-secrets.outputs.missing }}"
          if [[ -n "$missing" ]]; then
            echo "Secrets not available in this context: $missing. Remaining steps will be skipped."
          else
            echo "Secrets not available in this context. Remaining steps will be skipped."
          fi

      - name: Restore clasp credentials from secret
        if: steps.deploy-secrets.outputs.available == 'true'
        run: |
          mkdir -p ~
          cat <<'JSON' > ~/.clasprc.json
          ${{ secrets.CLASPRC_JSON }}
          JSON
          chmod 600 ~/.clasprc.json

      - name: Check clasp login status
        if: steps.deploy-secrets.outputs.available == 'true'
        shell: bash
        run: |
          if clasp login --status; then
            echo "clasp credentials restored successfully"
          else
            echo "::error::Unable to validate clasp authentication. Ensure the CLASPRC_JSON secret is valid." >&2
            exit 1
          fi

      - name: Inject scriptId
        if: steps.deploy-secrets.outputs.available == 'true'
        working-directory: ${{ env.PROJECT_PATH }}
        env:
          SCRIPT_ID: ${{ secrets[env.SCRIPT_ID_SECRET] }}
        run: |
          if [[ -z "$SCRIPT_ID" ]]; then
            echo "::error::Missing ${{ env.SCRIPT_ID_SECRET }} secret."
            exit 1
          fi
          tmp_file="$(mktemp)"
          jq --arg scriptId "$SCRIPT_ID" '.scriptId = $scriptId' .clasp.json > "$tmp_file"
          mv "$tmp_file" .clasp.json

      - name: Deploy
        if: steps.deploy-secrets.outputs.available == 'true'
        working-directory: ${{ env.PROJECT_PATH }}
        run: clasp push -f
