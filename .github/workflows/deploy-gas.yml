name: Deploy Google Apps Script (monorepo)

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  toolchain-baseline:
    uses: ./.github/workflows/toolchain-version-guard.yml

  deploy:
    needs: toolchain-baseline
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        project:
          - apps-script/gas-main-app
          - apps-script/gas-second-app
          - apps-script/gas-cat-cafe
          - apps-script/gas-li-mu-yue-slides
          - apps-script/gas-ledger-sheet

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install clasp (3.x)
        run: npm install -g @google/clasp@^3.1.0

      - name: Restore clasp credentials from secret
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          if [ -z "${CLASPRC_JSON}" ]; then
            echo "ERROR: GitHub secret CLASPRC_JSON is missing." >&2
            exit 1
          fi
          printf '%s\n' "${CLASPRC_JSON}" > "${HOME}/.clasprc.json"
          chmod 600 "${HOME}/.clasprc.json"

      - name: Check clasp login status
        run: clasp login --status

      - name: "Guard: require scriptId before deploy"
        working-directory: ${{ matrix.project }}
        env:
          PROJECT: ${{ matrix.project }}
        run: |
          if [ ! -f ".clasp.json" ]; then
            echo "::error title=Missing Script ID::$PROJECT is in the deploy matrix but has no .clasp.json. Remove it from the matrix or finish onboarding before deploying." >&2
            exit 1
          fi
          node <<'EOF'
          const fs = require('fs');
          const path = '.clasp.json';
          const raw = fs.readFileSync(path, 'utf8');
          const data = JSON.parse(raw);
          const scriptId = (data.scriptId || '').trim();
          const pattern = /^[A-Za-z0-9_-]{20,}$/;
          if (!pattern.test(scriptId)) {
            console.error(`::error title=Missing Script ID::${process.env.PROJECT} has an empty or invalid scriptId in ${path}.`);
            process.exit(1);
          }
          EOF

      - name: Deploy ${{ matrix.project }}
        env:
          PROJECT_PATH: ${{ matrix.project }}
        working-directory: ${{ matrix.project }}
        run: |
          echo "Deploying ${PROJECT_PATH}"
          if [ ! -f ".clasp.json" ]; then
            echo "::warning::Skipping ${PROJECT_PATH} because .clasp.json is missing. Link this folder to an Apps Script project before deploying."
            exit 0
          fi
          clasp push -f
