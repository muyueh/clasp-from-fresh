name: Deploy Google Apps Script (taipei-500-form)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        project:
          - path: taipei-500-form
            scriptIdSecret: TAIPEI_500_FORM_SCRIPT_ID

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install clasp (3.x)
        run: npm install -g @google/clasp@^3.1.0

      - name: Restore clasp credentials from secret
        run: |
          mkdir -p ~
          cat <<'JSON' > ~/.clasprc.json
          ${{ secrets.CLASPRC_JSON }}
          JSON
          chmod 600 ~/.clasprc.json

      - name: Check clasp login status
        shell: bash
        run: |
          if clasp login --status; then
            echo "clasp credentials restored successfully"
          else
            echo "::error::Unable to validate clasp authentication. Ensure the CLASPRC_JSON secret is valid." >&2
            exit 1
          fi

      - name: Inject scriptId for ${{ matrix.project.path }}
        working-directory: ${{ matrix.project.path }}
        env:
          SCRIPT_ID: ${{ secrets[matrix.project.scriptIdSecret] }}
        run: |
          if [[ -z "$SCRIPT_ID" ]]; then
            echo "::error::Missing ${{ matrix.project.scriptIdSecret }} secret."
            exit 1
          fi
          tmp_file="$(mktemp)"
          jq --arg scriptId "$SCRIPT_ID" '.scriptId = $scriptId' .clasp.json > "$tmp_file"
          mv "$tmp_file" .clasp.json

      - name: Deploy ${{ matrix.project.path }}
        working-directory: ${{ matrix.project.path }}
        run: clasp push -f
